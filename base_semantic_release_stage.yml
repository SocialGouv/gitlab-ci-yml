#

variables:
  GIT_AUTHOR_EMAIL: 45039513+SocialGroovyBot@users.noreply.github.com
  GIT_AUTHOR_NAME: Social Groovy Bot
  GIT_COMMITTER_EMAIL: $GIT_AUTHOR_EMAIL
  GIT_COMMITTER_NAME: $GIT_AUTHOR_NAME
  #
  # Additional plugins
  SEMANTIC_RELEASE_PLUGINS: "@semantic-release/changelog @semantic-release/git"
  SEMANTIC_RELEASE_ARGS: ""

.base_trigger_release_stage:
  image: curlimages/curl:7.67.0
  dependencies: []
  when: manual
  variables:
    GIT_STRATEGY: none
  only:
    refs:
      - branches
  except:
    variables:
      # Don't run when running e2e tests
      - $E2E_TEST
      # Don't run when deploying in production an existing image
      - $PRODUCTION
      # Don't run when tagging a commit
      - $RELEASE
  script:
    - curl --request POST
      --form ref="${CI_COMMIT_REF_NAME}"
      --form token="${CI_JOB_TOKEN}"
      --form variables[RELEASE]="true"
      ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/trigger/pipeline

.base_semantic_release_stage:
  stage: "Notify Finished Deployment"
  dependencies: []
  image: node:12.14-alpine3.10
  variables:
    LERNA_ARGS: --force-publish --yes
    #
    GIT_DEPTH: 4242
  only:
    variables:
      - $RELEASE
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - node_modules
      - $CI_PROJECT_DIR/.yarn
  before_script:
  script:
    # Ensure to have "git" and "jq"
    - apk add --no-cache git=~2 jq=~1
    # Set git to a branch
    - git checkout ${CI_COMMIT_REF_NAME}
    # Use github as origin
    - git remote set-url origin https://${GITHUB_TOKEN}@github.com/${CI_PROJECT_PATH}.git

    # HACK(douglasduteil): remove all packages dependencies on monoreops
    # To make the installation blazing fast, we remove all packages dependencies
    # Only the root package.json dependencies will be installed
    - find packages -maxdepth 1 -type d | tail -n +2 |
      xargs -I {} sh -c "[[ -f "{}/package.json" ]] || exit 0 ; {
        rm {}/package.json ;
        jq 'del(.dependencies) | del(.devDependencies)' > {}/package.json
      ; } < {}/package.json"

    # Use local yarn cache
    - yarn config set cache-folder $CI_PROJECT_DIR/.yarn
    # Should only install workspace dependencies
    - yarn --frozen-lockfile

    # HACK(douglasduteil): remove all packages dependencies
    # Restore the package files before bumping versions.
    # As Lerna will commit, we need to restore the files as they were
    - git checkout -- .

    # Run lerna version
    - echo "yarn lerna version ${LERNA_ARGS}"
    - GH_TOKEN=${GITHUB_TOKEN} yarn lerna version ${LERNA_ARGS}
