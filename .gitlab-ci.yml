---

include:
  - /base_semantic_release_stage.yml

stages:
  - Code Quality
  - Release

workflow:
  rules:
    # Don't run when tagging a commit
    - if: $RELEASE
      when: never
    - if: $CI_COMMIT_BRANCH

Lint:
  stage: Code Quality
  image: node:13-alpine
  script:
    - npx yaml-lint *.yml
    - npx prettier --check *.yml

Trigger release:
  stage: Code Quality
  extends:
    - .base_trigger_release_stage

Release:
  stage: Release
  extends:
    - .base_semantic_release_stage
  variables:
    SEMANTIC_RELEASE_PLUGINS: "@semantic-release/changelog @semantic-release/exec @semantic-release/git"

Test AutoDevOps on SocialGouv/sample-next-app:
  stage: Code Quality
  image: curlimages/curl:7.69.0
  variables:
    GIT_STRATEGY: none
  script:
    - "[[ -z ${SOCIAL_GOUV_SAMPLE_NEXT_APP_PROJECT_ID} ]] && exit ${CI_JOB_SKIP_EXIT_CODE:-0}"
    - curl --request POST
        --form ref="autodevops-master"
        --form token="${CI_JOB_TOKEN}"
        "${CI_API_V4_URL}/projects/${SOCIAL_GOUV_SAMPLE_NEXT_APP_PROJECT_ID}/trigger/pipeline"
  only:
    refs:
      - master
