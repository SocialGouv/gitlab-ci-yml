#

variables:
  K8S_FOLDER: ${CI_PROJECT_DIR}/.k8s
  KOSKO_GENERATE_ARGS: ""
  # renovate: datasource=github-releases depName=socialgouv/k8s
  NOK8S_VERSION: v1.6.0

.print_env: &print_env |
  printenv | grep \
    -e "^AUTO_" \
    -e "^CI_COMMIT_" \
    -e "^CI_ENVIRONMENT_" \
    -e "^CI_PROJECT_" \
    -e "^CI_REGISTRY_" \
    -e "^KUBE_INGRESS_BASE_DOMAIN" \
    -e "^KUBE_NAMESPACE" \
    -e "^PRODUCTION" \
    -e "^KOSKO_" \
    -e "^RANCHER_PROJECT_ID" | sort

.base_deploy_kosko_stage:
  stage: Deploy
  # todo: use gitlab-deploy image
  image: ghcr.io/socialgouv/docker/kubectl:sha-12af17fb38dc2c19e2101b2a2b28a82b2ca4f24b
  dependencies: []
  cache:
    key:
      files:
        - ${K8S_FOLDER}/yarn.lock
      prefix: ${CI_JOB_NAME}
    paths:
      - ${CI_PROJECT_DIR}/.cache
      - ${K8S_FOLDER}/node_modules
  script:
    - *print_env
    - |
      if [[ -d "${CI_PROJECT_DIR}/.socialgouv" ]]; then
        echo "Use .socialgouv config."
        echo "Use no-k8s version $NOK8S_VERSION"
        git clone --depth 1 --branch $NOK8S_VERSION https://github.com/SocialGouv/k8s socialgouv
        rm -rf ./socialgouv/.socialgouv
        cp -r ${CI_PROJECT_DIR}/.socialgouv ./socialgouv/
        if [[ -d "./socialgouv/.socialgouv/environments" ]]; then
          cp -r ./socialgouv/.socialgouv/environments/* ./socialgouv/.k8s/environments/
        fi
        if [[ -d "./socialgouv/.socialgouv/components" ]]; then
          cp -r ./socialgouv/.socialgouv/components/* ./socialgouv/.k8s/components/
        fi
        cd ./socialgouv/.k8s
      else
        yarn config set cache-folder ${CI_PROJECT_DIR}/.cache/yarn
        cd ${K8S_FOLDER}
      fi
    - echo "yarn --production --frozen-lockfile --prefer-offline --link-duplicates"
    - yarn --production --frozen-lockfile --prefer-offline --link-duplicates
    #
    - echo "yarn -s kosko generate ${KOSKO_GENERATE_ARGS} >> ${CI_PROJECT_DIR}/manifest.yaml"
    - yarn -s kosko generate ${KOSKO_GENERATE_ARGS} > ${CI_PROJECT_DIR}/manifest.yaml
    #
    - cd -
    - |
      if [[ -d "${KOSKO_APPEND_YAML_FROM}" ]]; then
        echo "Append to ${CI_PROJECT_DIR}/manifest.yaml"
        find ${KOSKO_APPEND_YAML_FROM} -name '*.yaml'
        find ${KOSKO_APPEND_YAML_FROM} -name '*.yaml' -exec \
          echo '---' \; -exec cat {} \; \
        >> ${CI_PROJECT_DIR}/manifest.yaml
      fi
    - |
      if [[ -n $AUTO_DEVOPS_ENABLE_KAPP ]]; then
        if [[ -z $PRODUCTION ]]; then
          kubectl create ns ${KUBE_NAMESPACE} || true
          kubectl annotate ns ${KUBE_NAMESPACE} azure-pg-admin-user=${CI_PROJECT_NAME} || true
        fi
        kapp --dangerous-override-ownership-of-existing-resources -y deploy -a ${CI_PROJECT_NAME} --namespace ${KUBE_NAMESPACE} -f ${CI_PROJECT_DIR}/manifest.yaml ${KAPP_DEPLOY_ARGS}
      else
        kubectl apply -f ${CI_PROJECT_DIR}/manifest.yaml
      fi
    - |
      echo ""
      echo ""
      echo "******************************************************************************************"
      [[ -f "${CI_PROJECT_DIR}/manifest.yaml" ]] && yq e -N '.spec.rules[0].host' "${CI_PROJECT_DIR}/manifest.yaml" | grep -v null | sed -e s/^/\ \ ðŸš€\ https\:\\/\\// || true
      echo "******************************************************************************************"
      echo ""
      echo ""
  artifacts:
    expire_in: 1 week
    paths:
      - manifest.yaml
    when: always

.base_kosko_k8s_test:
  stage: Code Quality
  extends:
    - .base_deploy_kosko_stage
  script:
    - *print_env
    #
    - yarn config set cache-folder ${CI_PROJECT_DIR}/.cache/yarn
    - cd ${K8S_FOLDER}
    - yarn --frozen-lockfile --prefer-offline --link-duplicates
    # HACK(douglasduteil): pre-cache jest
    # As it's most likely being used to test our kosko charts
    - yarn add -D jest --frozen-lockfile --prefer-offline --link-duplicates
    #
    - yarn test
